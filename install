#!/bin/bash

set -eu

function check_existence
{
  printf "Checking for $1... "
  which $1 > /dev/null 2>&1
  exists=$?
  if [ "$exists" -eq "0" ];
  then
    echo "found" 1>&2
  else
    echo "not found; see the README" 1>&2
    exit 1
  fi
}
check_existence "mount"
check_existence "modprobe"
check_existence "chroot"
check_existence "curl"
check_existence "sed"
check_existence "grep"
#check_existence "unsquashfs"

## Setup essential variables; allow overriding with input
root_mount=$(mount | grep "/ " | sed 's/ /\n/' | head -n1)
grub_device=$(echo $root_mount | sed "s|[0-9]\+||")
root_type=$(mount | grep -Eo "/ type \w+" | sed 's/ /\n/g' | tail -n1)

while getopts ":g:r:t:" opt; do
  case $opt in
    g)
      grub_device=$OPTARG
      ;;
    r)
      root_mount=$OPTARG
      ;;
    t)
      root_type=$OPTARG
      ;;
    \?)
      echo "ERROR invalid option: -$OPTARG" >&2
      exit 1
      ;;
    :)
      echo "ERROR option -$OPTARG requires an argument." >&2
      exit 1
      ;;
  esac
done

## Give one last chance to back out
read -p \
"Installing NixOS into $root_mount ($root_type) and GRUB into $grub_device;
continue? [yn] " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]
then
  echo "exiting; nothing was harmed"
  exit 1
fi

echo "running"
exit

here="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

iso=latest-iso-minimal-x86_64-linux
if [ ! -d host/nix/store ];
then
  mkdir -p mnt host/nix
  curl -# http://nixos.org/releases/nixos/$iso
  modprobe loop
  mount -o loop $iso mnt
  unsquashfs -d host/nix/store mnt/nix-store.squashfs '*'
fi

## Save one space
rm -f latest-iso-minimal-x86_64-linux

## Setup the chroot environment before install
$here/stage1 $here

## TODO: Clean up mounts

## Installation is complete
read -p "reboot into NixOS now? [yn] " -n 1 -r
echo
[[ $REPLY =~ ^[Yy]$ ]] && reboot
