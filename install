#!/bin/bash

set -eu

## TODO: Input validation
here="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

function check_existence
{
  printf "Checking for $1... "
  which $1 > /dev/null 2>&1
  exists=$?
  if [ "$exists" -eq "0" ];
  then
    echo "found" 1>&2
  else
    echo "not found; see the README" 1>&2
    exit 1
  fi
}
check_existence "mount"
check_existence "modprobe"
check_existence "chroot"
check_existence "curl"
check_existence "pcregrep"
check_existence "unsquashfs"

iso=latest-iso-minimal-x86_64-linux
if [ ! -d host/nix/store ];
then
  mkdir -p mnt host/nix
  curl -# http://nixos.org/releases/nixos/$iso
  modprobe loop
  mount -o loop $iso mnt
  unsquashfs -d host/nix/store mnt/nix-store.squashfs '*'
fi

## Save one space
rm -f latest-iso-minimal-x86_64-linux

## Setup the chroot environment before install
$here/stage1 $here
